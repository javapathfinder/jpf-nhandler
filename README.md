# jpf-nhandler

jpf-nhandler is an extension of **Java PathFinder (JPF)** that automatically delegates the execution of selected methods from JPF to the host JVM.

When a method call `o.m(a)` is delegated, jpf-nhandler performs the following steps:

1. Transforms the JPF representation of the object `o` and arguments `a` to their host JVM representations.
2. Executes the original (native or non-native) method `m` on the host JVM.
3. Transforms the result back into its JPF representation.

The implementation mainly relies on **MJI (Model Java Interface)** and generates native peers on-the-fly using the **BCEL** library. These generated peers are referred to as **on-the-fly (OTF) peers**.

---

## Requirements

- **Java 11 (recommended)**
  - Java 8 may still work, but Java 11 is the primary supported version
- Git
- Gradle (via the included Gradle wrapper)
- `jpf-core` installed and built

To check your Java version:

```bash
java -version
Project Structure
php
Copy code
jpf-nhandler/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â””â”€â”€ java/        # jpf-nhandler implementation
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ java/        # unit tests
â”œâ”€â”€ onthefly/
â”‚   â”œâ”€â”€ *.java           # generated on-the-fly native peer sources (optional)
â”‚   â””â”€â”€ *.class          # generated bytecode
â”œâ”€â”€ build.gradle
â””â”€â”€ README.md
src/main/java contains the core implementation of jpf-nhandler

src/test/java contains unit tests

onthefly/ contains generated native peer sources and bytecode when source generation is enabled

Installing jpf-nhandler
1. Install jpf-core
Follow the instructions on the jpf-core wiki.
It is recommended to clone the master branch and build it using the Gradle wrapper.

Note: Some jpf-core tests may fail. This does not prevent using JPF.

2. Clone jpf-nhandler
bash
Copy code
git clone https://github.com/javapathfinder/jpf-nhandler.git
cd jpf-nhandler
3. Build jpf-nhandler
bash
Copy code
./gradlew build
A successful build may produce warnings related to internal Java APIs, which are expected.

4. Run Tests
bash
Copy code
./gradlew test
All tests should pass before using the extension.

5. Register jpf-nhandler
Add jpf-nhandler to your site.properties file as described in the jpf-core documentation.

Running JPF with jpf-nhandler
To run JPF with jpf-nhandler enabled, include the following in your .jpf file:

properties
Copy code
@using = jpf-nhandler

target = Example

nhandler.delegateUnhandledNative = true

classpath = path-to-application-classes
native_classpath = path-to-application-classes
Important Note on Classpaths
Classes belonging to the System Under Test (SUT) must be accessible to both:

JPF (classpath)

Host JVM (native_classpath)

Since execution alternates between JPF and the host JVM, the same directories or JAR files should be specified for both properties.

Configuration Options
jpf-nhandler provides several configuration options.

Delegating Methods
Delegate a specific constructor:

properties
Copy code
nhandler.spec.delegate = a.b.C.<init>
Delegate all methods of a class:

properties
Copy code
nhandler.spec.delegate = java.lang.String.*
Skipping Methods
Skip a specific method (executed as empty and returns a dummy value):

properties
Copy code
nhandler.spec.skip = java.io.FileDescriptor.write
Delegate Only Unhandled Native Calls
properties
Copy code
nhandler.delegateUnhandledNative = true
On-the-Fly Native Peers
jpf-nhandler generates native peers dynamically.
Generated peers are stored in:

bash
Copy code
jpf-nhandler/onthefly/
Generate Source Code for OTF Peers
properties
Copy code
nhandler.genSource = true
Compile Generated Sources Manually
bash
Copy code
javac -cp "<JPF_HOME>/build/jpf.jar:<NHANDLER_HOME>/build/jpf-nhandler.jar" onthefly/*.java
Reuse Generated Peers Across Runs
properties
Copy code
nhandler.clean = false
Limitations
Platform-specific classes (e.g., java.lang.System) cannot be handled due to JVM inconsistencies

Delegated objects and classes must have consistent fields and superclasses in both JPF and the host JVM

Side effects must be observable only via return values, arguments, or the invoking object

Objects with native-managed state (e.g., java.awt.Window) cannot be handled

Licensing
jpf-nhandler is free software distributed under the GNU General Public License v3 (or later).

The licenses of third-party JAR files in lib/example are included with the project.

Questions / Feedback
For questions, comments, or suggestions, please contact:

ðŸ“§ nastaran.shafiei@gmail.com

Acknowledgements
Thanks to Peter Mehlitz for his help with the development of jpf-nhandler.
